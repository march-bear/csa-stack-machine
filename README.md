# АК 2024. Лабораторная работа №3
+ Марухленко Иван Сергеевич
+ Группа P3233
+ Вариант `lisp -> asm | stack | harv | hw | instr | binary -> struct | stream | port | pstr | prob2 | cache`
+ Выполнен упрощенный вариант `asm | stack | harv | hw | instr | struct | stream | port | pstr | prob2 | -`

## Язык программирования

``` ebnf
program ::= "section .data\n" { data_line } "section .code\n" { code_line } | { code_line }

data_line ::= label "\n" 
            | "word" integer "\n" 
            | "word" pos_integer, string "\n" 
            | "buf" pos_integer "\n"

code_line ::= label "\n" 
            | instr "\n"

label ::= label_name ":"

instr ::= op0 
        | op1 label_name 
        | op2 integer
        | op2 (label_name)

op0 ::= "dup"
    | "add"
    | "dec"
    | "swap"
    | "push_by"
    | "print"
    | "input"
    | "halt"

op1 ::= "jz"
    | "jg"
    | "jmp"
    | "pop"
    | "push"

op2 ::= "push"

pos_integer ::= "0" | [ <any of "1-9"> ] { <any of "0-9"> }

integer ::= [ "-" ] pos_integer

string ::= '"' { <any symbol except '"'> } '"' | "'" { <any symbol except "'"> } "'"

label_name ::= <any of "a-z A-Z _"> { <any of "a-z A-Z 0-9 _"> }
```

Код выполняется последовательно, начиная с первой строки, если секции не указаны, иначе начиная с первой строки после `section .code`

## Организация памяти
### Память команд
+ Машинное слово - не определено
+ Реализуется списком словарей, описывающих инструкции

### Память данных
+ Машинное слово - 32 бита
+ Адресное пространство линейное, адресуется числами от 0 до n

## Система команд
### Набор инструкций
| Язык                           | Инструкция         | Кол-во тактов | Описание                                                                                |
|--------------------------------|--------------------|---------------|-----------------------------------------------------------------------------------------|
| `dup`                          | DUP                |       0       | Дублирует значение на вершине стека                                                     |
| `add`                          | ADD                |       0       | Берет два значения с вершины стека и кладет на стек их сумму                            |
| `dec`                          | DEC                |       0       | Берет два значения с вершины стека и кладет на стек их разность                         |
| `swap`                         | SWAP               |       0       | Меняет местами два значения на вершине стека                                            |
| `mod2`                         | MOD2               |       0       | Берет значение с вершины стека и кладет на стек остаток от деления этого значения на 2  |
| `print`                        | PRINT              |       0       | Берет значение с вершины стека и отправляет его на порт вывода                          |
| `input`                        | INPUT              |       0       | Читает значение из порта ввода и кладет его на стек                                     |
| `jmp <addr>`                   | JMP `<addr>`       |       0       | Совершает переход на инструкцию по адресу `<addr>`                                      |
| `jz <addr>`                    | JZ `<addr>`        |       0       | Совершает переход на инструкцию по адресу `<addr>`, если на вершине стека 0             |
| `jg <addr>`                    | JG `<addr>`        |       0       | Совершает переход на инструкцию по адресу `<addr>`, если на вершине отрицательное число |
| `push_by`                      | PUSH_BY            |       0       | Берет адрес с вершины стека и кладет на стек значение из памяти по этому адресу         |
| `push <int>` or `push <label>` | PUSH `<int\|addr>` |       0       | Кладет на стек число/адрес `<int\|addr>`                                                |
| `pop <addr>`                   | POP `<addr>`       |       0       | Берет значение с вершины стека и записывает его в память по адресу `<addr>`             |
| `halt`                         | HALT               |       0       | Останов                                                                                 |

### Кодирование инструкций


## Транслятор

## Модель процессора

Интерфейс командной строки: `machine.py <program_file> [<input_file>]`.

Метод запуска симуляции `simulation` реализован в файле [machine.py](machine.py)

### DataPath
![datapath diagram](diagrams/datapath.png)
Реализован в классе [Datapath](datapath.py)
+ `Data stack` - аппаратный стек, либо кладем новое значение на вершину, либо удаляем
+ `TOS` - регистр вершины стека, отделен для возможности подачи на АЛУ сразу 2-х значений со стека
+ `Data mem` - память данных, однопортовая
+ `AR` - адресный регистр
+ `BR` - буферный регистр, используется для реализации инструкций процесоора (например, SWAP)
+ `ALU` - арифметико-логическое устройство, способно выполнять операции +/-, а также форматировать результат под остаток деления на 2 (mod 2)

Сигналы:
+ `latch_<Register>` - защелкнуть в регистре значение, поданное на его вход (может определяться другими сигналами)
+ `TOS_in` - выбрать значение на входе TOS (BR/Arg от CU/Memory/ALU/Input)
+ `ALU_L` - выбрать аргумент, подаваемый на левый вход АЛУ (0 или значение со стека)
+ `ALU_R` - выбрать аргумент, подаваемый на правый вход АЛУ (0 или значение из TOS)
+ `ALU_op` - выбрать операцию в АЛУ (+/-)
+ `ALU_mod` - выводить из АЛУ результат операции/результат mod 2
+ `push` - защелкнуть в стеке значение на его входе
+ `pop` - удалить значение с вершины стека
+ `wr` - записать значение (Data) по адресу (Addr) в память
+ `oe` - прочитать значение по адресу (Addr) из памяти

Флаги:
+ `zero` - TOS == 0
+ `neg` - TOS < 0


### ControlUnit
![controlunit diagram](diagrams/controlunit.png)
Реализован в классе [ControlUnit](controlunit.py)
+ `Instruction pointer` - регистр с адресом текущей инструкции
+ `Program mem` - память команд
+ `Instruction decoder` - схема для преобразования инструкций процессора в низкоуровневые сигналы
+ `IA` - регистр, хранящий аргумент текущей инструкции. Может быть использован Datapath (например, при исполнении команды push <integer>), или в ControlUnit для хранения адреса прыжка

Сигналы:
+ `latch_<register>` - защелкнуть значение на входе регистра
+ `sel_IP_value` - выбор значения на входе IP

## Тестирование